<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>GRF Salud - Inventario Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        .screen { 
            display: none; 
            min-height: 100vh; 
        }
        .screen.active { 
            display: block; 
            animation: fadeIn 0.3s; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        .campo-compacto {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 8px;
            align-items: center;
        }
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .processing-overlay.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- OVERLAY DE PROCESAMIENTO -->
<div id="processing-overlay" class="processing-overlay">
    <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center">
        <div class="w-20 h-20 bg-purple-100 rounded-full mx-auto mb-4 flex items-center justify-center">
            <svg class="w-12 h-12 text-purple-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Procesando fotos</h3>
        <p class="text-gray-600 mb-4">Extrayendo datos con OCR...</p>
        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
            <div id="processing-progress" class="bg-purple-600 h-3 rounded-full transition-all" style="width: 0%"></div>
        </div>
        <p class="text-sm text-gray-500"><span id="processing-count">0</span> de <span id="processing-total">0</span> fotos</p>
    </div>
</div>

<!-- SPLASH -->
<div id="splash" class="screen active">
    <div class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-purple-600 to-indigo-700">
        <div class="text-center text-white">
            <div class="w-24 h-24 bg-white bg-opacity-20 rounded-3xl mx-auto mb-6 flex items-center justify-center">
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-bold mb-2">GRF Salud SLU</h1>
            <p class="text-xl mb-8">Sistema de Inventario Cloud</p>
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
            <p class="text-sm opacity-75">Inicializando...</p>
        </div>
    </div>
</div>

<!-- ALMACENES -->
<div id="almacenes" class="screen">
    <div class="min-h-screen bg-gray-50 pb-20">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 pb-8">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">GRF Salud SLU</h1>
                    <p class="text-sm opacity-75">Inventario Cloud</p>
                </div>
            </div>
        </div>
        
        <div class="px-6 -mt-4">
            <!-- Estado de conexi√≥n -->
            <div id="connection-status" class="bg-white rounded-2xl shadow-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-600">Estado de conexi√≥n</p>
                        <p id="status-text" class="text-sm font-bold text-gray-900">Verificando...</p>
                    </div>
                    <div id="status-icon" class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                        <span class="text-xl">üì°</span>
                    </div>
                </div>
                
                <!-- Google Drive Status -->
                <div id="drive-status" class="mt-3 hidden">
                    <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üìÅ</span>
                            <div>
                                <p class="text-xs font-semibold text-blue-900">Google Drive</p>
                                <p id="drive-status-text" class="text-xs text-blue-700">No conectado</p>
                            </div>
                        </div>
                        <button id="btn-drive-auth" onclick="autenticarGoogleDrive()" class="px-3 py-1 bg-blue-600 text-white text-xs font-semibold rounded">
                            Conectar
                        </button>
                    </div>
                </div>
                
                <div id="pending-photos-alert" class="mt-3 hidden">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                        <p class="text-xs font-semibold text-orange-800"><span id="pending-count">0</span> fotos pendientes de procesar</p>
                        <button onclick="procesarFotosPendientes()" class="mt-2 w-full bg-orange-600 text-white text-xs font-semibold py-2 rounded-lg">
                            Procesar ahora
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-2">üì¶ Selecciona almac√©n</h2>
                <p class="text-sm text-gray-600">Completa el inventario inicial de cada ubicaci√≥n</p>
            </div>
            
            <div class="space-y-3">
                <!-- MU√ëO -->
                <div class="bg-white border-2 border-purple-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè¢</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 text-lg">MU√ëO</h3>
                                <p class="text-sm text-gray-500">Almac√©n Central</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('MU√ëO', 'Almac√©n Central')" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">
                        Comenzar inventario ‚Üí
                    </button>
                </div>
                
                <!-- HSA -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè•</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">HSA</h3>
                                <p class="text-sm text-gray-500">Hospital San Agust√≠n</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('HSA', 'Hospital San Agust√≠n')" class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-xl hover:bg-gray-200 transition">
                        Comenzar inventario
                    </button>
                </div>
                
                <!-- HCAB -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè•</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">HCAB</h3>
                                <p class="text-sm text-gray-500">Hospital de Cabue√±es</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('HCAB', 'Hospital de Cabue√±es')" class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-xl hover:bg-gray-200 transition">
                        Comenzar inventario
                    </button>
                </div>
                
                <!-- HUCA -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè•</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">HUCA</h3>
                                <p class="text-sm text-gray-500">Hospital Universitario Central</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('HUCA', 'Hospital Universitario Central de Asturias')" class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-xl hover:bg-gray-200 transition">
                        Comenzar inventario
                    </button>
                </div>
                
                <!-- CLIAST -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè•</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">CLIAST</h3>
                                <p class="text-sm text-gray-500">Cl√≠nica Asturias</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('CLIAST', 'Cl√≠nica Asturias')" class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-xl hover:bg-gray-200 transition">
                        Comenzar inventario
                    </button>
                </div>
                
                <!-- HMN -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-cyan-500 to-cyan-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè•</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">HMN</h3>
                                <p class="text-sm text-gray-500">Hospital Monte Naranco</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('HMN', 'Hospital Monte Naranco')" class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-xl hover:bg-gray-200 transition">
                        Comenzar inventario
                    </button>
                </div>
                
                <!-- HVN -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                                <span class="text-3xl">üè•</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">HVN</h3>
                                <p class="text-sm text-gray-500">Hospital Valle del Nal√≥n</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="iniciarInventario('HVN', 'Hospital Valle del Nal√≥n')" class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-xl hover:bg-gray-200 transition">
                        Comenzar inventario
                    </button>
                </div>
            </div>
            
            <div class="mt-6 bg-purple-50 border border-purple-200 rounded-xl p-4">
                <p class="text-sm font-medium text-purple-900 mb-1">‚òÅÔ∏è Sistema Cloud + OCR</p>
                <p class="text-xs text-purple-700">Captura fotos offline. Se procesan autom√°ticamente cuando hay internet. Las fotos originales se guardan en Google Drive.</p>
            </div>
        </div>
    </div>
</div>

<!-- INVENTARIO PROGRESO -->
<div id="inventario-progreso" class="screen">
    <div class="min-h-screen bg-white pb-24">
        <div class="sticky top-0 bg-white border-b z-10">
            <div class="px-6 py-4">
                <button onclick="irAtras()" class="text-gray-600 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h2 class="text-lg font-bold text-gray-900">INVENTARIO: <span id="almacen-actual"></span></h2>
                <p class="text-sm text-gray-500"><span id="almacen-nombre"></span></p>
                <div class="bg-gray-200 h-2 rounded-full mt-3">
                    <div id="progreso-bar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-2"><span id="productos-count">0</span> fotos capturadas ¬∑ <span id="productos-procesados">0</span> procesadas</p>
            </div>
        </div>
        
        <div class="p-6">
            <button onclick="capturarFoto()" class="w-full bg-purple-600 text-white font-bold py-4 rounded-xl shadow-lg mb-4">
                üì∏ Capturar etiqueta
            </button>
            
            <button onclick="diagnosticar()" class="w-full bg-gray-600 text-white py-2 rounded-xl mb-4 text-xs">
                üîç Diagn√≥stico (debug)
            </button>
            
            <button onclick="imprimirListado()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl mb-4">
                üñ®Ô∏è Imprimir listado
            </button>
            
            <div id="lista-productos" class="space-y-3">
                <div class="text-center text-gray-400 py-8">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <p class="text-sm font-medium">A√∫n no hay productos</p>
                    <p class="text-xs mt-2">Presiona "Capturar etiqueta"</p>
                </div>
            </div>
        </div>
        
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
            <button onclick="finalizarInventario()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl">
                ‚úÖ Finalizar inventario
            </button>
        </div>
    </div>
</div>

<!-- REVISI√ìN DE PRODUCTO -->
<div id="revision-producto" class="screen">
    <div class="min-h-screen bg-white pb-24">
        <div class="sticky top-0 bg-white border-b px-6 py-3 z-10">
            <button onclick="irAtras()" class="text-gray-600 mb-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h2 class="text-base font-bold">‚úÖ Verificar datos extra√≠dos</h2>
        </div>
        
        <div class="p-4">
            <!-- Foto miniatura -->
            <div class="mb-4">
                <img id="foto-revision" class="w-full rounded-lg border-2 border-gray-300" style="max-height: 150px; object-fit: contain;">
            </div>
            
            <!-- Almac√©n destino -->
            <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-3 mb-4">
                <p class="text-xs text-purple-600 font-medium">üìç Almac√©n</p>
                <p class="text-sm font-bold text-purple-900"><span id="almacen-destino-revision"></span></p>
            </div>
            
            <!-- Campos -->
            <div class="space-y-2">
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-purple-700">REF:</label>
                    <input type="text" id="ref-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg font-mono text-base bg-white">
                </div>
                
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-gray-700">MD:</label>
                    <input type="text" id="md-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-base bg-white">
                </div>
                
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-gray-700">DESC:</label>
                    <input type="text" id="nombre-revision" class="px-3 py-2 border-2 border-purple-300 rounded-lg text-base">
                </div>
                
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-gray-700">ESPEC:</label>
                    <input type="text" id="especif-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-base">
                </div>
                
                <div>
                    <div class="campo-compacto">
                        <label class="text-xs font-bold text-red-700">CAD:</label>
                        <input type="text" id="cad-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg font-mono text-base bg-white">
                    </div>
                    <div id="alerta-cad-revision" class="mt-1 px-2 py-1 bg-green-50 border border-green-200 rounded ml-16 hidden">
                        <p class="text-xs text-green-700"></p>
                    </div>
                </div>
                
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-orange-700">LOT:</label>
                    <input type="text" id="lot-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg font-mono text-base bg-white">
                </div>
                
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-gray-700">STERILE:</label>
                    <input type="text" id="esteril-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg font-mono text-base bg-white">
                </div>
                
                <div class="campo-compacto">
                    <label class="text-xs font-bold text-gray-700">FAB:</label>
                    <input type="text" id="fabricante-revision" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-base bg-white">
                </div>
            </div>
        </div>
        
        <!-- Botones -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3">
            <button onclick="confirmarProducto()" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg">
                ‚úÖ Confirmar y continuar
            </button>
        </div>
    </div>
</div>

<!-- RESUMEN -->
<div id="resumen" class="screen">
    <div class="min-h-screen bg-gray-50 pb-20">
        <div class="sticky top-0 bg-white border-b px-6 py-4">
            <button onclick="irAtras()" class="text-gray-600 mb-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h2 class="text-lg font-bold">Resumen inventario</h2>
            <p class="text-sm text-gray-500"><span id="resumen-almacen"></span></p>
        </div>
        
        <div class="p-6">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">üìä Estad√≠sticas</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-purple-50 rounded-xl p-4">
                        <p class="text-xs text-purple-600">Unidades totales</p>
                        <p class="text-3xl font-bold text-purple-700"><span id="total-unidades">0</span></p>
                    </div>
                    <div class="bg-blue-50 rounded-xl p-4">
                        <p class="text-xs text-blue-600">Productos √∫nicos</p>
                        <p class="text-3xl font-bold text-blue-700"><span id="productos-unicos">0</span></p>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button onclick="confirmarInventario()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl">
                    ‚úÖ Confirmar inventario
                </button>
                <button onclick="irAPantalla('inventario-progreso')" class="w-full bg-purple-600 text-white py-3 rounded-xl">
                    üì∏ Capturar m√°s etiquetas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="fixed top-20 left-4 right-4 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 hidden">
    <div class="flex items-center">
        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span id="toast-msg"></span>
    </div>
</div>

<script>
// Configuraci√≥n
const GOOGLE_API_KEY = 'AIzaSyCpx62NcQewZR9wxiO4VAlkN3zsPLwxBOI';
const GOOGLE_CLIENT_ID = '734101798954-vqg6ujll8med8kk5f7d75n7suv1nmgkt.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// Variables globales
var navHistory = [];
var pantallaActual = 'splash';
var almacenActual = '';
var almacenNombre = '';
var productos = [];
var fotosPendientes = [];
var productoActualIndex = -1;
var isOnline = navigator.onLine;
var gapiInited = false;
var gisInited = false;
var tokenClient;
var accessToken = null;
var carpetaDriveId = null;

// Navegaci√≥n
function irAPantalla(id) {
    if (pantallaActual) {
        navHistory.push(pantallaActual);
    }
    
    var pantallas = document.querySelectorAll('.screen');
    for (var i = 0; i < pantallas.length; i++) {
        pantallas[i].classList.remove('active');
    }
    
    var pantalla = document.getElementById(id);
    if (pantalla) {
        pantalla.classList.add('active');
        pantallaActual = id;
        window.scrollTo(0, 0);
    }
}

function irAtras() {
    if (navHistory.length > 0) {
        var anterior = navHistory.pop();
        
        var pantallas = document.querySelectorAll('.screen');
        for (var i = 0; i < pantallas.length; i++) {
            pantallas[i].classList.remove('active');
        }
        
        var pantalla = document.getElementById(anterior);
        if (pantalla) {
            pantalla.classList.add('active');
            pantallaActual = anterior;
            window.scrollTo(0, 0);
        }
    }
}

function toast(msg) {
    document.getElementById('toast-msg').textContent = msg;
    document.getElementById('toast').classList.remove('hidden');
    setTimeout(function() {
        document.getElementById('toast').classList.add('hidden');
    }, 3000);
}

// Estado de conexi√≥n
function actualizarEstadoConexion() {
    isOnline = navigator.onLine;
    var statusText = document.getElementById('status-text');
    var statusIcon = document.getElementById('status-icon');
    
    if (isOnline) {
        statusText.textContent = '‚úÖ Conectado a internet';
        statusIcon.innerHTML = '<span class="text-xl">‚úÖ</span>';
        statusIcon.className = 'w-10 h-10 bg-green-100 rounded-full flex items-center justify-center';
        
        // Verificar fotos pendientes
        verificarFotosPendientes();
    } else {
        statusText.textContent = 'üìµ Sin conexi√≥n (modo offline)';
        statusIcon.innerHTML = '<span class="text-xl">üìµ</span>';
        statusIcon.className = 'w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center';
    }
}

function verificarFotosPendientes() {
    var pendientes = fotosPendientes.filter(f => !f.procesada);
    var alert = document.getElementById('pending-photos-alert');
    
    if (pendientes.length > 0 && isOnline) {
        document.getElementById('pending-count').textContent = pendientes.length;
        alert.classList.remove('hidden');
        
        // Procesar autom√°ticamente
        setTimeout(procesarFotosPendientes, 1000);
    } else {
        alert.classList.add('hidden');
    }
}

// Monitorear cambios de conexi√≥n
window.addEventListener('online', function() {
    actualizarEstadoConexion();
    toast('‚úÖ Conexi√≥n restaurada');
});

window.addEventListener('offline', function() {
    actualizarEstadoConexion();
    toast('üìµ Sin conexi√≥n - Modo offline');
});

function iniciarInventario(codigo, nombre) {
    almacenActual = codigo;
    almacenNombre = nombre;
    document.getElementById('almacen-actual').textContent = codigo;
    document.getElementById('almacen-nombre').textContent = nombre;
    document.getElementById('productos-count').textContent = '0';
    document.getElementById('productos-procesados').textContent = '0';
    productos = [];
    fotosPendientes = [];
    irAPantalla('inventario-progreso');
}

// Captura de foto
function capturarFoto() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment';
    
    input.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        
        var reader = new FileReader();
        reader.onload = async function(event) {
            var fotoData = event.target.result;
            var timestamp = new Date().toISOString();
            var nombreArchivo = almacenActual + '_' + timestamp.replace(/[:.]/g, '-') + '.jpg';
            
            // Guardar foto pendiente
            var fotoInfo = {
                data: fotoData,
                timestamp: timestamp,
                almacen: almacenActual,
                nombreArchivo: nombreArchivo,
                procesada: false,
                driveId: null
            };
            
            // Subir a Drive si est√° conectado
            if (accessToken && carpetaDriveId && isOnline) {
                toast('üì§ Subiendo a Google Drive...');
                var driveResult = await subirFotoADrive(fotoData, nombreArchivo);
                if (driveResult) {
                    fotoInfo.driveId = driveResult.id;
                    fotoInfo.driveUrl = driveResult.webViewLink;
                    toast('‚úÖ Foto guardada en Drive');
                }
            }
            
            fotosPendientes.push(fotoInfo);
            
            actualizarContadores();
            toast('üì∏ Foto capturada');
            
            // Si hay internet, procesar autom√°ticamente
            if (isOnline) {
                setTimeout(procesarFotosPendientes, 500);
            }
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}

function actualizarContadores() {
    var total = fotosPendientes.length;
    var procesadas = fotosPendientes.filter(f => f.procesada).length;
    
    document.getElementById('productos-count').textContent = total;
    document.getElementById('productos-procesados').textContent = procesadas;
    
    var progreso = total > 0 ? (procesadas / total) * 100 : 0;
    document.getElementById('progreso-bar').style.width = progreso + '%';
}

// Procesamiento con Google Cloud Vision
async function procesarFotosPendientes() {
    console.log('üîÑ Iniciando procesamiento de fotos...');
    
    if (!isOnline) {
        console.log('‚ùå Sin conexi√≥n');
        toast('‚ö†Ô∏è Sin conexi√≥n. Las fotos se procesar√°n cuando haya internet.');
        return;
    }
    
    var pendientes = fotosPendientes.filter(f => !f.procesada);
    console.log('üì∏ Fotos pendientes de procesar:', pendientes.length);
    
    if (pendientes.length === 0) {
        console.log('‚úÖ No hay fotos pendientes');
        return;
    }
    
    // Mostrar overlay
    document.getElementById('processing-overlay').classList.add('active');
    document.getElementById('processing-total').textContent = pendientes.length;
    
    for (var i = 0; i < pendientes.length; i++) {
        console.log('üîÑ Procesando foto ' + (i+1) + '/' + pendientes.length);
        document.getElementById('processing-count').textContent = i + 1;
        var progreso = ((i + 1) / pendientes.length) * 100;
        document.getElementById('processing-progress').style.width = progreso + '%';
        
        try {
            var resultado = await procesarFotoConVision(pendientes[i].data);
            pendientes[i].datosExtraidos = resultado;
            pendientes[i].procesada = true;
            console.log('‚úÖ Foto procesada:', resultado);
        } catch (error) {
            console.error('‚ùå Error procesando foto:', error);
            pendientes[i].error = error.message;
            pendientes[i].procesada = false;
        }
    }
    
    // Ocultar overlay
    document.getElementById('processing-overlay').classList.remove('active');
    
    actualizarContadores();
    toast('‚úÖ Fotos procesadas');
    
    console.log('‚úÖ Procesamiento completado');
    
    // Mostrar primera foto para revisi√≥n
    mostrarSiguienteFotoParaRevision();
}

async function procesarFotoConVision(base64Image) {
    // Extraer solo el base64 (sin el prefijo data:image/...)
    var base64Data = base64Image.split(',')[1];
    
    var requestBody = {
        requests: [{
            image: { content: base64Data },
            features: [{ type: 'TEXT_DETECTION' }]
        }]
    };
    
    var response = await fetch('https://vision.googleapis.com/v1/images:annotate?key=' + GOOGLE_API_KEY, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
        throw new Error('Error en Vision API: ' + response.status);
    }
    
    var data = await response.json();
    var texto = data.responses[0].textAnnotations ? data.responses[0].textAnnotations[0].description : '';
    
    return parsearTextoEtiqueta(texto);
}

function parsearTextoEtiqueta(texto) {
    console.log('Texto extra√≠do:', texto);
    
    var resultado = {
        ref: '',
        md: '',
        nombre: '',
        especif: '',
        caducidad: '',
        lot: '',
        esteril: '',
        fabricante: ''
    };
    
    // Limpiar texto
    var textoLimpio = texto.replace(/\n/g, ' ').replace(/\s+/g, ' ');
    
    // Extraer REF
    var refMatch = textoLimpio.match(/REF[:\s]*(\d{4}\.\d{2}\.\d{3})/i);
    if (refMatch) resultado.ref = refMatch[1];
    
    // Extraer MD
    var mdMatch = textoLimpio.match(/MD[:\s]*([\w\s\-+]+?)(?=\s+\w+:|$)/i);
    if (mdMatch) resultado.md = mdMatch[1].trim();
    
    // Extraer fecha de caducidad
    var cadMatch = textoLimpio.match(/(\d{4})-(\d{2})-(\d{2})/);
    if (cadMatch) resultado.caducidad = cadMatch[0];
    
    // Extraer LOT
    var lotMatch = textoLimpio.match(/LOT[:\s]*(\d+)/i);
    if (lotMatch) resultado.lot = lotMatch[1];
    
    // Extraer STERILE
    var sterileMatch = textoLimpio.match(/STERILE\s+(?:R|EO)\s+(\d+)/i);
    if (sterileMatch) resultado.esteril = sterileMatch[1];
    
    // Fabricante
    if (textoLimpio.indexOf('LimaCorporate') !== -1 || textoLimpio.indexOf('Lima Corporate') !== -1) {
        resultado.fabricante = 'LimaCorporate S.p.A.';
    }
    
    // Buscar nombre/descripci√≥n
    var nombreMatch = textoLimpio.match(/MD[:\s]*[\w\s\-+]+?\s+([\w\s\-+\/]+?)(?=\s+\d{4}-\d{2}-\d{2})/i);
    if (nombreMatch) {
        var nombreCompleto = nombreMatch[1].trim();
        if (nombreCompleto.indexOf('/') !== -1) {
            var partes = nombreCompleto.split('/');
            resultado.nombre = partes[1] ? partes[1].trim() : partes[0].trim();
        } else {
            resultado.nombre = nombreCompleto;
        }
    }
    
    return resultado;
}

function mostrarSiguienteFotoParaRevision() {
    // Buscar siguiente foto procesada sin confirmar
    var pendiente = null;
    var indice = -1;
    
    for (var i = 0; i < fotosPendientes.length; i++) {
        if (fotosPendientes[i].procesada && !fotosPendientes[i].confirmada) {
            pendiente = fotosPendientes[i];
            indice = i;
            break;
        }
    }
    
    if (!pendiente) {
        // No hay m√°s fotos para revisar
        actualizarLista();
        return;
    }
    
    productoActualIndex = indice;
    
    // Mostrar foto y datos
    document.getElementById('foto-revision').src = pendiente.data;
    document.getElementById('almacen-destino-revision').textContent = almacenActual + ' - ' + almacenNombre;
    
    var datos = pendiente.datosExtraidos;
    document.getElementById('ref-revision').value = datos.ref;
    document.getElementById('md-revision').value = datos.md;
    document.getElementById('nombre-revision').value = datos.nombre;
    document.getElementById('especif-revision').value = datos.especif;
    document.getElementById('cad-revision').value = datos.caducidad;
    document.getElementById('lot-revision').value = datos.lot;
    document.getElementById('esteril-revision').value = datos.esteril;
    document.getElementById('fabricante-revision').value = datos.fabricante;
    
    if (datos.caducidad) {
        calcularDiasCaducidadRevision(datos.caducidad);
    }
    
    irAPantalla('revision-producto');
}

function calcularDiasCaducidadRevision(fechaCad) {
    if (!fechaCad) return;
    
    var hoy = new Date();
    var caducidad = new Date(fechaCad);
    var diferencia = caducidad - hoy;
    var dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
    
    var alerta = document.getElementById('alerta-cad-revision');
    var texto = alerta.querySelector('p');
    alerta.classList.remove('hidden');
    
    if (dias < 0) {
        texto.innerHTML = '‚ö†Ô∏è <strong>CADUCADO</strong>';
        alerta.className = 'mt-1 px-2 py-1 bg-red-50 border border-red-200 rounded ml-16';
    } else if (dias < 180) {
        texto.innerHTML = '‚ö†Ô∏è <strong>' + dias + ' d√≠as</strong> hasta caducidad';
        alerta.className = 'mt-1 px-2 py-1 bg-yellow-50 border border-yellow-200 rounded ml-16';
    } else {
        texto.innerHTML = '‚úì <strong>' + dias + ' d√≠as</strong> hasta caducidad';
        alerta.className = 'mt-1 px-2 py-1 bg-green-50 border border-green-200 rounded ml-16';
    }
}

function confirmarProducto() {
    if (productoActualIndex === -1) return;
    
    var producto = {
        ref: document.getElementById('ref-revision').value.trim(),
        md: document.getElementById('md-revision').value.trim(),
        nombre: document.getElementById('nombre-revision').value.trim(),
        especif: document.getElementById('especif-revision').value.trim(),
        caducidad: document.getElementById('cad-revision').value.trim(),
        lot: document.getElementById('lot-revision').value.trim(),
        esteril: document.getElementById('esteril-revision').value.trim(),
        fabricante: document.getElementById('fabricante-revision').value.trim()
    };
    
    if (!producto.ref || !producto.lot || !producto.caducidad) {
        alert('‚ö†Ô∏è Completa al menos REF, LOT y CADUCIDAD');
        return;
    }
    
    productos.push(producto);
    fotosPendientes[productoActualIndex].confirmada = true;
    
    toast('‚úÖ Producto confirmado');
    
    // Mostrar siguiente
    mostrarSiguienteFotoParaRevision();
}

function actualizarLista() {
    var agrupados = {};
    for (var i = 0; i < productos.length; i++) {
        var p = productos[i];
        var clave = p.ref + '|' + p.lot + '|' + p.caducidad + '|' + p.esteril;
        if (!agrupados[clave]) {
            agrupados[clave] = {
                ref: p.ref,
                lot: p.lot,
                caducidad: p.caducidad,
                esteril: p.esteril,
                nombre: p.nombre,
                cantidad: 0
            };
        }
        agrupados[clave].cantidad++;
    }
    
    var lista = document.getElementById('lista-productos');
    lista.innerHTML = '';
    for (var clave in agrupados) {
        var item = agrupados[clave];
        var unidadesTexto = item.cantidad > 1 ? item.cantidad + ' uds' : '1 ud';
        lista.innerHTML += '<div class="bg-gray-50 border-2 rounded-xl p-4">' +
            '<p class="font-bold text-sm mb-1">' + item.ref + '&nbsp;&nbsp;&nbsp;&nbsp;LOT ' + item.lot + '&nbsp;&nbsp;&nbsp;&nbsp;CAD ' + item.caducidad + '</p>' +
            '<p class="text-sm text-gray-700">‚úÖ ' + unidadesTexto + ' - ' + (item.nombre || 'Sin descripci√≥n') + '</p>' +
            '</div>';
    }
}

function finalizarInventario() {
    // Verificar si hay fotos sin confirmar
    var sinConfirmar = fotosPendientes.filter(f => f.procesada && !f.confirmada).length;
    
    if (sinConfirmar > 0) {
        if (!confirm('Hay ' + sinConfirmar + ' fotos procesadas sin confirmar. ¬øContinuar de todos modos?')) {
            return;
        }
    }
    
    if (productos.length === 0) {
        toast('‚ö†Ô∏è No hay productos confirmados');
        return;
    }
    
    document.getElementById('resumen-almacen').textContent = almacenActual + ' - ' + almacenNombre;
    document.getElementById('total-unidades').textContent = productos.length;
    
    var unicos = {};
    for (var i = 0; i < productos.length; i++) {
        var p = productos[i];
        var clave = p.ref + '|' + p.lot + '|' + p.caducidad + '|' + p.esteril;
        unicos[clave] = true;
    }
    document.getElementById('productos-unicos').textContent = Object.keys(unicos).length;
    
    irAPantalla('resumen');
}

function confirmarInventario() {
    toast('‚úÖ Inventario confirmado');
    setTimeout(function() {
        productos = [];
        fotosPendientes = [];
        irAPantalla('almacenes');
    }, 2000);
}

function imprimirListado() {
    if (productos.length === 0) {
        toast('‚ö†Ô∏è No hay productos para imprimir');
        return;
    }
    
    var ventana = window.open('', '', 'width=800,height=600');
    ventana.document.write('<html><head><title>Inventario - ' + almacenActual + '</title>');
    ventana.document.write('<style>');
    ventana.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
    ventana.document.write('h1 { color: #7c3aed; }');
    ventana.document.write('h2 { color: #666; font-size: 16px; margin-bottom: 20px; }');
    ventana.document.write('.producto { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; }');
    ventana.document.write('.linea1 { font-weight: bold; margin-bottom: 5px; }');
    ventana.document.write('.linea2 { color: #555; }');
    ventana.document.write('.resumen { margin-top: 30px; padding: 15px; background: #f3f4f6; border-radius: 8px; }');
    ventana.document.write('</style></head><body>');
    ventana.document.write('<h1>GRF Salud SLU - Inventario</h1>');
    ventana.document.write('<h2>' + almacenActual + ' - ' + almacenNombre + '</h2>');
    ventana.document.write('<p><strong>Fecha:</strong> ' + new Date().toLocaleDateString('es-ES') + ' ' + new Date().toLocaleTimeString('es-ES') + '</p>');
    
    var agrupados = {};
    for (var i = 0; i < productos.length; i++) {
        var p = productos[i];
        var clave = p.ref + '|' + p.lot + '|' + p.caducidad + '|' + p.esteril;
        if (!agrupados[clave]) {
            agrupados[clave] = {
                ref: p.ref,
                lot: p.lot,
                caducidad: p.caducidad,
                esteril: p.esteril,
                nombre: p.nombre,
                cantidad: 0
            };
        }
        agrupados[clave].cantidad++;
    }
    
    for (var clave in agrupados) {
        var item = agrupados[clave];
        var unidadesTexto = item.cantidad > 1 ? item.cantidad + ' uds' : '1 ud';
        ventana.document.write('<div class="producto">');
        ventana.document.write('<div class="linea1">' + item.ref + '    LOT ' + item.lot + '    CAD ' + item.caducidad + '</div>');
        ventana.document.write('<div class="linea2">‚úÖ ' + unidadesTexto + ' - ' + (item.nombre || 'Sin descripci√≥n') + '</div>');
        ventana.document.write('</div>');
    }
    
    ventana.document.write('<div class="resumen">');
    ventana.document.write('<strong>Total unidades escaneadas:</strong> ' + productos.length + '<br>');
    ventana.document.write('<strong>Productos √∫nicos:</strong> ' + Object.keys(agrupados).length);
    ventana.document.write('</div>');
    
    ventana.document.write('</body></html>');
    ventana.document.close();
    ventana.print();
}

// Funci√≥n de diagn√≥stico
function diagnosticar() {
    var msg = 'üîç DIAGN√ìSTICO DEL SISTEMA\n\n';
    msg += 'üì° Conexi√≥n:\n';
    msg += '  ‚Ä¢ Internet: ' + (isOnline ? '‚úÖ Conectado' : '‚ùå Sin conexi√≥n') + '\n';
    msg += '  ‚Ä¢ GAPI: ' + (gapiInited ? '‚úÖ OK' : '‚ùå No iniciado') + '\n';
    msg += '  ‚Ä¢ GIS: ' + (gisInited ? '‚úÖ OK' : '‚ùå No iniciado') + '\n\n';
    
    msg += 'üîë Autenticaci√≥n:\n';
    msg += '  ‚Ä¢ API Key: ' + (GOOGLE_API_KEY ? '‚úÖ Configurado' : '‚ùå Falta') + '\n';
    msg += '  ‚Ä¢ Access Token: ' + (accessToken ? '‚úÖ Autenticado' : '‚ùå No autenticado') + '\n';
    msg += '  ‚Ä¢ Carpeta Drive: ' + (carpetaDriveId ? '‚úÖ ' + carpetaDriveId : '‚ùå No creada') + '\n\n';
    
    msg += 'üì∏ Fotos:\n';
    msg += '  ‚Ä¢ Total capturadas: ' + fotosPendientes.length + '\n';
    
    var procesadas = fotosPendientes.filter(function(f) { return f.procesada; }).length;
    var confirmadas = fotosPendientes.filter(function(f) { return f.confirmada; }).length;
    var enDrive = fotosPendientes.filter(function(f) { return f.driveId; }).length;
    
    msg += '  ‚Ä¢ Procesadas (OCR): ' + procesadas + '\n';
    msg += '  ‚Ä¢ Confirmadas: ' + confirmadas + '\n';
    msg += '  ‚Ä¢ Subidas a Drive: ' + enDrive + '\n\n';
    
    msg += 'üì¶ Productos:\n';
    msg += '  ‚Ä¢ Confirmados: ' + productos.length + '\n\n';
    
    if (fotosPendientes.length > 0) {
        msg += 'üìã Detalle de fotos:\n';
        for (var i = 0; i < Math.min(3, fotosPendientes.length); i++) {
            var f = fotosPendientes[i];
            msg += '  Foto ' + (i+1) + ':\n';
            msg += '    ‚Ä¢ Procesada: ' + (f.procesada ? '‚úÖ' : '‚è≥ Pendiente') + '\n';
            msg += '    ‚Ä¢ Confirmada: ' + (f.confirmada ? '‚úÖ' : '‚è≥ Pendiente') + '\n';
            msg += '    ‚Ä¢ Drive: ' + (f.driveId ? '‚úÖ' : '‚ùå') + '\n';
            if (f.error) {
                msg += '    ‚Ä¢ Error: ' + f.error + '\n';
            }
        }
        if (fotosPendientes.length > 3) {
            msg += '  ... y ' + (fotosPendientes.length - 3) + ' m√°s\n';
        }
    }
    
    console.log('=== DIAGN√ìSTICO COMPLETO ===');
    console.log(msg);
    console.log('Fotos pendientes:', fotosPendientes);
    console.log('Productos:', productos);
    
    alert(msg);
}

// Inicializaci√≥n
window.addEventListener('load', function() {
    console.log('üöÄ Iniciando aplicaci√≥n...');
    actualizarEstadoConexion();
    gapiLoaded();
    gisLoaded();
    setTimeout(function() {
        irAPantalla('almacenes');
    }, 1500);
});

// Inicializar Google API
function gapiLoaded() {
    gapi.load('client', async function() {
        await gapi.client.init({
            apiKey: GOOGLE_API_KEY,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        gapiInited = true;
        console.log('Google API inicializado');
        mostrarEstadoDrive();
    });
}

// Inicializar Google Identity Services
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: function(response) {
            if (response.error) {
                console.error('Error de autenticaci√≥n:', response);
                return;
            }
            accessToken = response.access_token;
            console.log('Autenticaci√≥n exitosa');
            actualizarEstadoDrive();
            crearCarpetaInventario();
        }
    });
    gisInited = true;
    console.log('Google Identity Services inicializado');
}

function mostrarEstadoDrive() {
    if (isOnline && gapiInited && gisInited) {
        document.getElementById('drive-status').classList.remove('hidden');
    }
}

function autenticarGoogleDrive() {
    if (!gisInited) {
        alert('Sistema de autenticaci√≥n no est√° listo. Espera un momento.');
        return;
    }
    
    tokenClient.requestAccessToken({ prompt: 'consent' });
}

function actualizarEstadoDrive() {
    if (accessToken) {
        document.getElementById('drive-status-text').textContent = '‚úÖ Conectado';
        document.getElementById('btn-drive-auth').textContent = 'Conectado';
        document.getElementById('btn-drive-auth').className = 'px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded';
        document.getElementById('btn-drive-auth').disabled = true;
    }
}

// Crear carpeta de inventario en Drive
async function crearCarpetaInventario() {
    try {
        // Buscar si ya existe la carpeta
        var response = await gapi.client.drive.files.list({
            q: "name='GRF Salud Inventario' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            spaces: 'drive',
            fields: 'files(id, name)'
        });
        
        if (response.result.files.length > 0) {
            carpetaDriveId = response.result.files[0].id;
            console.log('Carpeta encontrada:', carpetaDriveId);
        } else {
            // Crear nueva carpeta
            var fileMetadata = {
                name: 'GRF Salud Inventario',
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            var createResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            carpetaDriveId = createResponse.result.id;
            console.log('Carpeta creada:', carpetaDriveId);
        }
        
        toast('‚úÖ Google Drive conectado');
    } catch (error) {
        console.error('Error creando carpeta:', error);
    }
}

// Subir foto a Google Drive
async function subirFotoADrive(fotoData, nombreArchivo) {
    if (!accessToken || !carpetaDriveId) {
        console.log('No hay token o carpeta de Drive');
        return null;
    }
    
    try {
        // Convertir base64 a blob
        var base64Data = fotoData.split(',')[1];
        var mimeType = fotoData.split(',')[0].split(':')[1].split(';')[0];
        var byteCharacters = atob(base64Data);
        var byteNumbers = new Array(byteCharacters.length);
        for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        var byteArray = new Uint8Array(byteNumbers);
        var blob = new Blob([byteArray], { type: mimeType });
        
        // Metadata del archivo
        var metadata = {
            name: nombreArchivo,
            mimeType: mimeType,
            parents: [carpetaDriveId]
        };
        
        // Crear form data
        var form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);
        
        // Subir
        var response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            body: form
        });
        
        if (!response.ok) {
            throw new Error('Error subiendo archivo: ' + response.status);
        }
        
        var result = await response.json();
        console.log('Foto subida a Drive:', result.id);
        return result;
    } catch (error) {
        console.error('Error subiendo a Drive:', error);
        return null;
    }
}
</script>
</body>
</html>
